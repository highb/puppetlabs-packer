{
  "variables": {
    "template_name"                                        : null,
    "beakerhost"                                           : null,
    "version"                                              : null,
    "puppet_aio"                                           : null,

    "vmware_vsphere_nocm_required_modules"                 : null,
    "vmware_vsphere_nocm_vmx_data_memsize"                 : null,
    "vmware_vsphere_nocm_vmx_data_numvcpus"                : null,
    "vmware_vsphere_nocm_vmx_data_ethernet0_virtualDev"    : "vmxnet3",
    "vmware_vsphere_nocm_vmx_data_ethernet0_pciSlotNumber" : "33",

    "support_status"                        : "puppet_maintained",
    "project_root"                          : "../../../..",
    "headless"                              : "true",
    "template_config"                       : "vsphere-nocm-pdbpreload",
    "provisioner"                           : "vmware",
    "shutdown_command"                      : "/sbin/halt -h -p",

    "qa_root_passwd"                        : "{{user `qa_root_passwd`}}",
    "qa_root_passwd_plain"                  : "{{user `qa_root_passwd_plain`}}",
    "packer_sha"                            : "{{user `packer_sha`}}",
    "packer_source_dir"                     : "{{user `packer_vm_src_dir`}}",
    "packer_output_dir"                     : "{{user `packer_vm_out_dir`}}"
  },

  "builders": [
    {
      "name"                                : "{{user `template_name`}}-{{user `provisioner`}}-{{user `template_config`}}",
      "vm_name"                             : "packer-{{build_name}}",
      "type"                                : "vmware-vmx",
      "source_path"                         : "{{user `packer_source_dir`}}/output-{{user `template_name`}}-{{user `provisioner`}}-base/packer-{{user `template_name`}}-{{user `provisioner`}}-vmware.vsphere.nocm.vmx",
      "output_directory"                    : "{{user `packer_output_dir`}}/output-{{build_name}}",

      "headless"                            : "{{user `headless`}}",

      "ssh_username"                        : "root",
      "ssh_password"                        : "puppet",
      "ssh_port"                            : 22,
      "ssh_wait_timeout"                    : "10000s",
      "ssh_pty"                             : "true",

      "shutdown_command"                    : "{{user `shutdown_command`}}",

      "vmx_data"                            : {
        "annotation"                        : "Packer build: {{user `template_name`}}-{{user `version`}} built {{isotime}} SHA: {{user `packer_sha`}}"
      },
      "vmx_data_post"                       : {
        "memsize"                           : "{{user `vmware_vsphere_nocm_vmx_data_memsize`}}",
        "numvcpus"                          : "{{user `vmware_vsphere_nocm_vmx_data_numvcpus`}}",
        "ethernet0.virtualDev"              : "{{user `vmware_vsphere_nocm_vmx_data_ethernet0_virtualDev`}}",
        "ethernet0.pciSlotNumber"           : "{{user `vmware_vsphere_nocm_vmx_data_ethernet0_pciSlotNumber`}}"
      }
    }
  ],

  "provisioners": [
    {
      "type"                                : "shell",
      "environment_vars"                    : [
        "PUPPET_AIO={{user `puppet_aio`}}",
        "PC_REPO= {{user `pc_repo` }}"
      ],
      "scripts"                             : [
        "{{user `project_root`}}/scripts/post/pe_install.sh",
        "{{user `project_root`}}/scripts/post/load_backup_db.sh"
      ]
    },
    
    {
      "type"                                : "shell",
      "environment_vars"                    : [
        "PUPPET_AIO={{user `puppet_aio`}}",
        "PC_REPO= {{user `pc_repo` }}"
      ],
      "scripts"                             : [
        "{{user `project_root`}}/scripts/cleanup-packer.sh",
        "{{user `project_root`}}/scripts/cleanup-scrub.sh"
      ]
    }
  ]
}
